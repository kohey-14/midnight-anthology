<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤œæ˜ã‘ã®ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Hina+Mincho&family=Zen+Maru+Gothic:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f8fb;
            --text-color: #000000;
            --accent-color: #5d6c7a;
            --btn-border: #000000;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Hina Mincho', serif;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            writing-mode: vertical-rl; /* ç¸¦æ›¸ã */
            /* è‹±æ•°å­—ã‚’å¯ã‹ã›ãšã€ç›´ç«‹ã•ã›ã‚‹è¨­å®š */
            text-orientation: upright; 
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.8) 0%, rgba(224, 236, 248, 0.4) 90%);
            overscroll-behavior: none;
        }

        .app-container {
            width: 85vw; 
            height: 80vh; 
            max-width: 600px;
            max-height: 800px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        h1 {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 0.3em;
            color: var(--text-color);
            margin: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            flex-shrink: 0;
            padding-left: 10px;
        }

        .display-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            overflow: hidden;
        }

        .task-text {
            font-size: 22px;
            line-height: 1.8;
            padding: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-feature-settings: "palt"; /* æ–‡å­—è©°ã‚ */
            color: #000;
            max-height: 60vh;
            overflow-x: auto;
            white-space: nowrap; 
            
            /* è‹±æ•°å­—ã‚‚ç¸¦ã«æ­£ç«‹ã•ã›ã‚‹ */
            text-orientation: upright; 
        }
        
        .task-text.long-text {
            white-space: normal;
            font-size: 18px;
        }

        .message-small {
            font-size: 11px;
            color: #333;
            margin-bottom: 10px;
            font-family: 'Zen Maru Gothic', sans-serif;
            text-orientation: upright; /* ã“ã“ã‚‚æ­£ç«‹ */
        }

        .button-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .btn {
            writing-mode: vertical-rl;
            text-orientation: upright;
            background: #fff;
            color: #000;
            border: 1px solid #000;
            padding: 15px 12px;
            font-size: 13px;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 50px;
            font-family: 'Zen Maru Gothic', sans-serif;
            white-space: nowrap;
        }
        .btn:hover { background: #000; color: #fff; }
        .btn-night { border-color: #6a5acd; color: #6a5acd; }
        .btn-night:hover { background: #6a5acd; color: #fff; }

        .hidden { display: none !important; }

        #timer-display {
            font-size: 28px;
            letter-spacing: 0.2em;
            color: #000;
            text-orientation: upright;
            font-family: 'Hina Mincho', serif;
            /* æ•°å­—ã®ã‚ºãƒ¬ã‚’è£œæ­£ */
            font-feature-settings: "tnum"; 
        }
        
        #task-time-display {
            text-orientation: upright; /* ã€Œ3åˆ†ã€ã®3ã‚’ç«‹ã¦ã‚‹ */
        }

        /* UIãƒ‘ãƒ¼ãƒ„ç¾¤ï¼ˆæ¨ªæ›¸ãã«æˆ»ã™ã‚¨ãƒªã‚¢ï¼‰ */
        .ui-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
            writing-mode: horizontal-tb; /* ã“ã“ã ã‘æ¨ªæ›¸ã */
        }

        .icon-btn {
            font-size: 18px;
            cursor: pointer;
            opacity: 0.5;
            background: rgba(255,255,255,0.8);
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }
        .icon-btn:hover { opacity: 1; }
        .icon-btn.active { background: #5d6c7a; color: #fff; opacity: 1; border:none; }

        .location-switch {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 20px;
            overflow: hidden;
            background: #fff;
            margin-top: 5px;
        }
        .loc-btn {
            padding: 6px 12px;
            font-family: 'Zen Maru Gothic';
            font-size: 11px;
            cursor: pointer;
            background: transparent;
            border: none;
            transition: 0.3s;
        }
        .loc-btn.active { background: #5d6c7a; color: #fff; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« (æ¨ªæ›¸ã) */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 200;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            writing-mode: horizontal-tb;
        }
        #settings-modal.active { display: flex; }

        .modal-content {
            width: 90%; max-width: 500px; background: #fff; padding: 20px;
            border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #eee;
            max-height: 80vh; display: flex; flex-direction: column;
        }

        .modal-title { font-family:'Zen Maru Gothic'; font-size:16px; margin-bottom:10px; text-align:center; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; font-size: 12px; color: #999; border-bottom: 2px solid transparent; }
        .tab.active { color: #333; border-bottom: 2px solid #5d6c7a; font-weight: bold; }
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
        #new-task-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size:14px;}
        #new-task-time { width: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size:14px;}
        .add-btn { padding: 8px 15px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size:12px;}
        .task-list { flex-grow: 1; overflow-y: auto; border-top: 1px solid #eee; min-height: 150px; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f5f5f5; font-size:14px; }
        .task-time-badge { font-size: 10px; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; margin-left: 8px; }
        .delete-btn { color: #ccc; cursor: pointer; margin-left:10px; font-size: 16px; }
        .close-modal-btn { margin-top: 15px; width: 100%; padding: 12px; background: #f5f5f5; border: none; color: #666; border-radius: 5px; cursor: pointer; }

        .debug-btn { position: fixed; bottom: 10px; right: 10px; writing-mode: horizontal-tb; font-size: 10px; color: #ccc; border:none; background:none; cursor: pointer; }

        /* å°åˆ·ç”¨ */
        #print-area { display: none; }
        @media print {
            body { background: #fff; display: block; writing-mode: vertical-rl; }
            .app-container, .ui-controls, #settings-modal, .debug-btn { display: none; }
            #print-area { display: block; width: 100%; height: 100%; padding: 30px; }
            .book-title-page { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; border-left: 1px solid #eee; margin-left: 20px; }
            .book-title { font-size: 28px; font-family: 'Hina Mincho', serif; margin-bottom: 20px; text-orientation: upright; }
            .book-date { font-size: 12px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter { height: 90vh; margin-right: 40px; border-left: 1px solid #f0f0f0; padding-left: 20px; display: flex; flex-direction: column; }
            .chapter-header { font-size: 10px; color: #666; margin-bottom: 30px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter-text { font-size: 14px; line-height: 2.2; text-align: justify; font-family: 'Hina Mincho', serif; color: #000; text-orientation: upright; }
            .chapter-footer { margin-top: auto; font-size: 10px; color: #666; text-align: right; text-orientation: upright; }
        }
    </style>
</head>
<body>

    <div class="ui-controls">
        <div class="icon-btn" onclick="openSettings()" title="è¡Œå‹•ãƒªã‚¹ãƒˆç·¨é›†">âš™</div>
        <div class="icon-btn" id="sound-toggle" onclick="toggleSound()" title="éŸ³ã®ON/OFF">ğŸ”‡</div>
        <div class="location-switch">
            <button class="loc-btn active" id="loc-home" onclick="switchLocation('home')">å®¶</button>
            <button class="loc-btn" id="loc-out" onclick="switchLocation('out')">å¤–</button>
        </div>
    </div>

    <div class="app-container">
        <h1>å¤œæ˜ã‘ã®ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼</h1>

        <div id="day-mode" style="display:flex; flex-direction:column; align-items:center; height:100%; width:100%;">
            
            <div id="phase-roulette" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="message-small" id="time-zone-msg"></div>
                
                <div class="display-area">
                    <div id="task-text" class="task-text">ãƒšãƒ¼ã‚¸ã‚’ã‚ãã‚‹</div>
                    <div id="task-time-display" style="font-size:12px; color:#888; margin-top:10px; font-family:'Zen Maru Gothic'; opacity:0;">ï¼ˆ3åˆ†ï¼‰</div>
                </div>
                
                <div class="button-area">
                    <button class="btn" id="btn-spin" onclick="startRoulette()">æ¢ã™</button>
                    <button class="btn hidden" id="btn-stop-roulette" onclick="stopRoulette()">ã“ã‚Œã«ã™ã‚‹</button>
                    <button class="btn hidden" id="btn-start-task" onclick="startFocus()">æ™‚é–“ã‚’ç´¡ã</button>
                </div>
            </div>

            <div id="phase-timer" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="message-small" id="timer-message">é™ã‹ãªæ™‚é–“</div>
                
                <div class="display-area">
                    <div id="timer-display">ã‚ã¨ ã€‡åˆ† ã€‡ã€‡ç§’</div>
                </div>
                
                <div class="button-area">
                    <button class="btn" onclick="stopFocus()" style="font-size:12px; padding:15px 10px;">æ ã‚’ã¯ã•ã‚€</button>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; color:#666; font-family:'Zen Maru Gothic'; letter-spacing:0.1em; flex-shrink:0;">
                <div style="text-orientation: upright;">ç‰©èªï¼š<span id="count-display" style="text-orientation: upright;">ã€‡</span> ç¯‡</div>
            </div>
        </div>

        <div id="night-mode" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
            <div class="display-area">
                <div style="font-size:16px; line-height:2.2; margin-bottom:30px;">
                    ä»Šæ—¥ä¸€æ—¥ã€<br>ã‚ãªãŸã¯ç¢ºã‹ã«ç”Ÿãã¦ã„ã¾ã—ãŸã€‚<br>
                    <span style="font-size:13px; color:#666;">ãã®è¨¼ã‚’ã€ä¸€å†Šã®æœ¬ã«ã€‚</span>
                </div>
            </div>
            <div class="button-area">
                <button class="btn btn-night" onclick="printBook()">è£½æœ¬ã™ã‚‹ (PDF)</button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">è¡Œå‹•ãƒªã‚¹ãƒˆã®ç·¨é›† (<span id="setting-mode-label">å®¶</span>)</div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('morning')">æœ</div>
                <div class="tab" onclick="switchTab('day')">æ˜¼</div>
                <div class="tab" onclick="switchTab('evening')">å¤•</div>
                <div class="tab" onclick="switchTab('night')">å¤œ</div>
            </div>
            <div class="input-group">
                <input type="text" id="new-task-input" placeholder="è¡Œå‹•ã‚’å…¥åŠ›">
                <input type="number" id="new-task-time" placeholder="åˆ†" min="0" value="3">
                <span style="font-size:12px; color:#666;">åˆ†</span>
                <button class="add-btn" onclick="addTask()">è¿½åŠ </button>
            </div>
            <div class="task-list" id="task-list-container"></div>
            <button class="close-modal-btn" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
            <div style="margin-top:10px; text-align:center;">
                <button onclick="resetDefaultTasks()" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; font-size:12px;">åˆæœŸãƒªã‚¹ãƒˆã«æˆ»ã™</button>
            </div>
        </div>
    </div>

    <div id="print-area"></div>
    <button class="debug-btn" onclick="forceNightMode()">[DEBUG] å¤œã¸</button>

    <audio id="bgm" loop></audio>

    <script>
        const kanjiNums = ['ã€‡','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
        function toKanji(num) {
            if (num < 10) return kanjiNums[num];
            const ten = Math.floor(num / 10);
            const one = num % 10;
            const str = (ten > 1 ? kanjiNums[ten] : '') + 'å' + (one > 0 ? kanjiNums[one] : '');
            return str;
        }

        const defaultTasksData = {
            home: {
                morning: [{text:"è¶³ã®æŒ‡ã‚’å‹•ã‹ã™",time:1}, {text:"æ°´ã‚’ä¸€æ¯é£²ã‚€",time:1}, {text:"çª“ã‚’é–‹ã‘ã‚‹",time:1}, {text:"é¡”ã‚’æ´—ã†",time:3}, {text:"æ·±å‘¼å¸ã‚’3å›",time:1}],
                day: [{text:"æœºã‚’æ‹­ã",time:3}, {text:"ãƒ¡ãƒ¼ãƒ«1é€š",time:5}, {text:"ã‚¹ãƒˆãƒ¬ãƒƒãƒ",time:3}, {text:"ã‚³ãƒ¼ãƒ’ãƒ¼æ·¹ã‚Œã‚‹",time:5}, {text:"ä¸è¦ãªç´™ã‚’æ¨ã¦ã‚‹",time:3}],
                evening: [{text:"ç›®ã‚’é–‰ã˜ã¦ä¼‘ã‚€",time:3}, {text:"è‚©ã‚’å›ã™",time:1}, {text:"ãŠèŒ¶ã‚’é£²ã‚€",time:5}, {text:"æ¤ç‰©ã«æ°´ã‚„ã‚Š",time:2}],
                night: [{text:"ä»Šæ—¥ã‚’æŒ¯ã‚Šè¿”ã‚‹",time:5}, {text:"å¥½ããªéŸ³æ¥½",time:5}, {text:"è‡ªåˆ†ã‚’æŠ±ãã—ã‚ã‚‹",time:1}, {text:"ã‚¹ãƒãƒ›ã‚’ç½®ã",time:10}]
            },
            out: {
                morning: [{text:"ç©ºã®è‰²ã‚’è¦‹ã‚‹",time:1}, {text:"æ·±ãæ¯ã‚’å¸ã†",time:1}, {text:"å§¿å‹¢ã‚’æ­£ã™",time:1}, {text:"ä»Šæ—¥ã®äºˆå®šã‚’è¦‹ã‚‹",time:2}],
                day: [{text:"é£²ã¿ç‰©ã‚’è²·ã†",time:3}, {text:"ã‚«ãƒãƒ³ã®ä¸­æ•´ç†",time:3}, {text:"èƒŒä¼¸ã³ã‚’ã™ã‚‹",time:1}, {text:"é ãã‚’è¦‹ã‚‹",time:1}],
                evening: [{text:"æ­©ãé€Ÿåº¦è½ã¨ã™",time:0}, {text:"ã‚·ãƒ§ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦",time:3}, {text:"ãƒ™ãƒ³ãƒã§ä¼‘ã‚€",time:5}, {text:"ç©ºã‚’è¦‹ä¸Šã’ã‚‹",time:1}],
                night: [{text:"æœˆã‚’æ¢ã™",time:1}, {text:"å®‰å…¨ã«æ­©ã",time:0}, {text:"ä»Šæ—¥ã«æ„Ÿè¬ã™ã‚‹",time:1}, {text:"æ·±å‘¼å¸",time:1}]
            }
        };

        const fragments = [
            { theme: "å‘¼å¸", text: "æ°´åº•ã«æ²ˆã‚“ã ã‚ˆã†ã«æ¯è‹¦ã—ã„æ—¥ã‚‚ã‚ã‚‹ã€‚ã‘ã‚Œã©ã€ã“ã†ã—ã¦æµ…ãã¦ã‚‚æ¯ã‚’ã—ã¦ã„ã‚‹ã€‚ãã‚Œã ã‘ã§ã€ç§ã¯ä»Šæ—¥ã‚’ç”ŸãæŠœã„ãŸã®ã ã¨è¨€ã£ã¦ã‚ã’ãŸã„ã€‚" },
            { theme: "æ³¢ç´‹", text: "ãŸã£ãŸã²ã¨ã¤ã®å°ã•ãªè¡Œå‹•ãŒã€æ³¢ç´‹ã®ã‚ˆã†ã«åºƒãŒã£ã¦ã„ãã€‚ä»Šã¯ã¾ã è¦‹ãˆãªãã¦ã‚‚ã€ãã‚Œã¯ç¢ºå®Ÿã«æœªæ¥ã®ç§ã¸ã¨å±Šã„ã¦ã„ã‚‹ã¯ãšã ã€‚" },
            { theme: "é›¨å®¿ã‚Š", text: "ç«‹ã¡æ­¢ã¾ã‚‹ã“ã¨ã¯ã€é€ƒã’ã‚‹ã“ã¨ã˜ã‚ƒãªã„ã€‚æ¿€ã—ã„é›¨ã‚’ã‚„ã‚Šéã”ã™ãŸã‚ã®ã€å¤§åˆ‡ãªé›¨å®¿ã‚Šã®æ™‚é–“ã ã€‚ã“ã“ã§ç¾½æ ¹ã‚’ä¼‘ã‚ã¦ã€ã¾ãŸç©ºãŒæ™´ã‚Œã‚‹ã®ã‚’å¾…ã¦ã°ã„ã„ã€‚" },
            { theme: "ç¯ç«", text: "èª°ã«ã‚‚æ°—ã¥ã‹ã‚Œãªã„ã‚ˆã†ãªå ´æ‰€ã§ã€ç§ã¯ç§ã®ãŸã‚ã®ç¯ã‚Šã‚’ã¨ã‚‚ã™ã€‚ã“ã®å°ã•ãªæ¸©ã‹ã•ãŒã‚ã‚Œã°ã€æš—ã„å¤œã‚‚æ€–ãã¯ãªã„ã€‚" },
            { theme: "å›å¾©", text: "å‚·ã¤ã„ãŸå¿ƒãŒå…ƒã«æˆ»ã‚‹ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚ã ã‹ã‚‰ç„¦ã‚‰ãªãã¦ã„ã„ã€‚ã‚†ã£ãã‚Šã¨ã€è–„ç´™ã‚’å‰¥ãã‚ˆã†ã«ã€ç§ã¯ç§ã‚’å–ã‚Šæˆ»ã—ã¦ã„ãã€‚" },
            { theme: "æ™‚é–“", text: "æµã‚Œã‚‹æ™‚é–“ã«è¿½ã‚ã‚Œã‚‹å¿…è¦ã¯ãªã„ã€‚ç§ã¯ãŸã ã€è‡ªåˆ†ã®å‘¼å¸ã®é€Ÿåº¦ã§ã€ã“ã®ä¸€ç¬ã‚’å‘³ã‚ãˆã°ã„ã„ã®ã ã€‚" }
        ];

        let tasksData = {};
        let collectedData = [];
        let currentMode = 'home'; 
        let currentTab = 'morning'; 
        let currentZone = 'morning';
        let rouletteInterval;
        let timerInterval;
        let totalSeconds = 180;
        let currentTaskObj = null;
        let isSoundOn = false; 
        
        const bgm = document.getElementById('bgm');
        bgm.src = "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"; 
        bgm.volume = 0.2;

        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadData();
            checkTime();
            updateCount();
            switchLocation('home');
            updateSoundIcon();
        });

        function toggleSound() {
            isSoundOn = !isSoundOn;
            if(!isSoundOn) {
                bgm.pause(); 
            }
            updateSoundIcon();
        }

        function updateSoundIcon() {
            const btn = document.getElementById('sound-toggle');
            if(isSoundOn) {
                btn.textContent = "ğŸ”Š";
                btn.classList.add('active');
            } else {
                btn.textContent = "ğŸ”‡";
                btn.classList.remove('active');
            }
        }

        function playBGM() {
            if(isSoundOn) {
                bgm.play().catch(() => {});
            }
        }

        function stopBGM() {
            bgm.pause();
        }

        function switchLocation(mode) {
            currentMode = mode;
            document.querySelectorAll('.loc-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('loc-' + mode).classList.add('active');
            checkTime();
        }

        function checkTime() {
            const hour = new Date().getHours();
            if (hour >= 23) {
                showNightMode();
                return;
            } else {
                showDayMode();
            }

            let msg = "";
            if (hour >= 6 && hour < 10) { 
                currentZone = 'morning'; 
                msg = (currentMode === 'home') ? "æœã®å…‰ã®ä¸­ã§ã€å°ã•ãå§‹ã‚ã‚‹ã€‚" : "æ–°ã—ã„ä¸€æ­©ã‚’ã€å¤–ã®ä¸–ç•Œã¸ã€‚";
            } else if (hour >= 10 && hour < 14) { 
                currentZone = 'day'; 
                msg = (currentMode === 'home') ? "æ—¥ä¸­ã®å–§é¨’ã‹ã‚‰ã€å°‘ã—é›¢ã‚Œã¦ã€‚" : "é¢¨ã‚’æ„Ÿã˜ã¦ã€å¿ƒã‚’è»½ãã€‚";
            } else if (hour >= 14 && hour < 18) { 
                currentZone = 'evening'; 
                msg = (currentMode === 'home') ? "å¤•æš®ã‚Œæ™‚ã€å¿ƒã‚’æ•´ãˆã‚‹ã€‚" : "å¸°ã‚Šé“ã€è‡ªåˆ†ã‚’åŠ´ã†ã€‚";
            } else if (hour >= 18 && hour < 23) { 
                currentZone = 'night'; 
                msg = (currentMode === 'home') ? "å¤œã®é™å¯‚ã«ã€èº«ã‚’å§”ã­ã¦ã€‚" : "å¤œé¢¨ã¨å…±ã«ã€é™ã‹ã«å¸°ã‚‹ã€‚";
            } else { 
                currentZone = 'morning'; 
                msg = "é™ã‹ãªåˆ»ã«ã€è€³ã‚’æ¾„ã¾ã™ã€‚"; 
            }
            
            const msgEl = document.getElementById('time-zone-msg');
            if(msgEl) msgEl.innerText = msg;
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            const label = document.getElementById('setting-mode-label');
            if(label) label.innerText = (currentMode === 'home' ? "å®¶" : "å¤–");
            switchTab(currentZone || 'morning');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchTab(zone) {
            currentTab = zone;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${zone}')"]`).classList.add('active');
            renderTaskList();
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = "";
            const list = tasksData[currentMode][currentTab] || [];
            
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `
                    <div class="task-info">
                        <span>${item.text}</span>
                        <span class="task-time-badge">${item.time}åˆ†</span>
                    </div>
                    <span class="delete-btn" onclick="deleteTask(${index})">Ã—</span>
                `;
                container.appendChild(div);
            });
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const timeInput = document.getElementById('new-task-time');
            const val = input.value.trim();
            const t = parseInt(timeInput.value);
            
            if (val && t >= 0) {
                if(!tasksData[currentMode]) tasksData[currentMode] = {};
                if(!tasksData[currentMode][currentTab]) tasksData[currentMode][currentTab] = [];
                
                tasksData[currentMode][currentTab].push({ text: val, time: t });
                saveTasks();
                renderTaskList();
                input.value = ""; 
                timeInput.value = "3";
            }
        }

        function deleteTask(index) {
            if(tasksData[currentMode] && tasksData[currentMode][currentTab]) {
                tasksData[currentMode][currentTab].splice(index, 1);
                saveTasks();
                renderTaskList();
            }
        }

        function resetDefaultTasks() {
            if(confirm("ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
                tasksData = JSON.parse(JSON.stringify(defaultTasksData));
                saveTasks();
                renderTaskList();
            }
        }

        function loadTasks() {
            const stored = localStorage.getItem('location_tasks_v30');
            if (stored) { 
                tasksData = JSON.parse(stored); 
            } else { 
                tasksData = JSON.parse(JSON.stringify(defaultTasksData)); 
            }
        }

        function saveTasks() {
            localStorage.setItem('location_tasks_v30', JSON.stringify(tasksData));
        }

        function startRoulette() {
            checkTime();
            const list = tasksData[currentMode][currentZone];
            
            if(!list || list.length === 0) {
                alert("ãƒªã‚¹ãƒˆãŒç©ºã§ã™ã€‚è¨­å®šã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            document.getElementById('btn-spin').classList.add('hidden');
            document.getElementById('btn-stop-roulette').classList.remove('hidden');
            document.getElementById('task-time-display').style.opacity = 0;
            
            const textBox = document.getElementById('task-text');
            textBox.classList.remove('long-text');

            rouletteInterval = setInterval(() => {
                const r = Math.floor(Math.random() * list.length);
                const txt = list[r].text;
                textBox.innerText = txt;
                if(txt.length > 8) textBox.classList.add('long-text');
                else textBox.classList.remove('long-text');
            }, 70);
        }

        function stopRoulette() {
            clearInterval(rouletteInterval);
            const list = tasksData[currentMode][currentZone];
            const r = Math.floor(Math.random() * list.length);
            
            currentTaskObj = list[r];
            const textBox = document.getElementById('task-text');
            textBox.innerText = currentTaskObj.text;
            
            if(currentTaskObj.text.length > 8) {
                textBox.classList.add('long-text');
            } else {
                textBox.classList.remove('long-text');
            }
            
            const timeDisplay = document.getElementById('task-time-display');
            timeDisplay.innerText = `ï¼ˆ${currentTaskObj.time}åˆ†ï¼‰`;
            timeDisplay.style.opacity = 1;
            
            playSoftSound();
            document.getElementById('btn-stop-roulette').classList.add('hidden');
            document.getElementById('btn-start-task').classList.remove('hidden');
        }

        function startFocus() {
            document.getElementById('phase-roulette').classList.add('hidden');
            document.getElementById('phase-timer').classList.remove('hidden');
            document.getElementById('timer-message').innerText = `ã€Œ${currentTaskObj.text}ã€ã®æ™‚é–“`;
            
            playBGM(); 
            
            totalSeconds = currentTaskObj.time * 60;
            if(totalSeconds <= 0) {
                 completeTask();
                 return;
            }
            updateTimerKanji();
            timerInterval = setInterval(() => {
                totalSeconds--;
                updateTimerKanji();
                if(totalSeconds <= 0) completeTask();
            }, 1000);
        }

        function updateTimerKanji() {
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            let mStr = m === 0 ? "ã€‡" : toKanji(m);
            let sStr = s < 10 ? "ã€‡" + toKanji(s) : toKanji(s);
            if(s === 0) sStr = "ã€‡ã€‡";
            document.getElementById('timer-display').innerText = `ã‚ã¨ ${mStr}åˆ† ${sStr}ç§’`;
        }

        function stopFocus() {
            clearInterval(timerInterval);
            stopBGM();
            resetPhase();
        }

        function completeTask() {
            clearInterval(timerInterval);
            stopBGM();
            
            const rand = Math.floor(Math.random() * fragments.length);
            const fragment = fragments[rand];
            
            collectedData.push({
                date: new Date(),
                action: currentTaskObj.text,
                content: fragment
            });
            saveData();
            updateCount();
            alert("ç‰©èªã®æ¬ ç‰‡ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚");
            resetPhase();
        }

        function resetPhase() {
            document.getElementById('phase-timer').classList.add('hidden');
            document.getElementById('phase-roulette').classList.remove('hidden');
            document.getElementById('btn-start-task').classList.add('hidden');
            document.getElementById('btn-spin').classList.remove('hidden');
            
            const textBox = document.getElementById('task-text');
            textBox.innerText = "æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸";
            textBox.classList.remove('long-text');
            
            document.getElementById('task-time-display').style.opacity = 0;
        }

        function showDayMode() {
            document.getElementById('day-mode').classList.remove('hidden');
            document.getElementById('night-mode').classList.add('hidden');
        }

        function showNightMode() {
            document.getElementById('day-mode').classList.add('hidden');
            document.getElementById('night-mode').classList.remove('hidden');
        }

        function forceNightMode() { showNightMode(); }

        function updateCount() {
            document.getElementById('count-display').innerText = toKanji(collectedData.length);
        }

        function saveData() {
            localStorage.setItem('anthology_data_v30', JSON.stringify(collectedData));
        }

        function loadData() {
            const data = localStorage.getItem('anthology_data_v30');
            if(data) {
                collectedData = JSON.parse(data);
                collectedData.forEach(d => d.date = new Date(d.date));
            }
        }

        function playSoftSound() {
            if(!isSoundOn) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }

        function printBook() {
            if(collectedData.length === 0) {
                alert("ç™½ç´™ã§ã™ã€‚");
                return;
            }
            const printArea = document.getElementById('print-area');
            const now = new Date();
            const dateStr = `${toKanji(now.getFullYear())}å¹´ ${toKanji(now.getMonth()+1)}æœˆ ${toKanji(now.getDate())}æ—¥`;
            let html = `<div class="book-title-page"><div class="book-title">å¤œæ˜ã‘ã®ã‚¢ãƒ³ã‚½ãƒ­ã‚¸ãƒ¼</div><div class="book-date">${dateStr}</div></div>`;
            
            collectedData.forEach(item => {
                const h = new Date(item.date).getHours();
                const m = new Date(item.date).getMinutes();
                html += `<div class="chapter"><div class="chapter-header">è©¦ã¿ï¼š${item.action}</div><div class="chapter-text">${item.content.text}</div><div class="chapter-footer">â€• ${item.content.theme}</div></div>`;
            });
            
            printArea.innerHTML = html;
            window.print();
        }
    </script>
</body>
</html>
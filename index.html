<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â§úÊòé„Åë„ÅÆ„Ç¢„É≥„ÇΩ„É≠„Ç∏„Éº</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#f4f8fb">
    <link href="https://fonts.googleapis.com/css2?family=Hina+Mincho&family=Zen+Maru+Gothic:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f8fb;
            --text-color: #333333;
            --accent-color: #5d6c7a;
            --line-color: #ccc;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Hina Mincho', serif;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            writing-mode: vertical-rl; /* Á∏¶Êõ∏„Åç */
            text-orientation: upright; /* Ëã±Êï∞Â≠ó„ÇíÊ≠£Á´ã */
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.8) 0%, rgba(224, 236, 248, 0.4) 90%);
            overscroll-behavior: none;
        }

        /* „Ç¢„Éó„É™ÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        .app-container {
            width: 85vw;
            height: 80vh;
            max-width: 600px;
            max-height: 800px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            
            padding: 30px 20px;
            position: relative;
            box-sizing: border-box;
        }

        /* --- UI„Ç≥„É≥„Éà„É≠„Éº„É´ÔºàÂ∑¶‰∏ä„ÉªÊ®™Êõ∏„ÅçÔºâ --- */
        .ui-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
            writing-mode: horizontal-tb;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
            color: #888;
        }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn.active { color: #5d6c7a; border-color: #5d6c7a; }

        /* ÂÆ∂/Â§ñ„Çπ„Ç§„ÉÉ„ÉÅ */
        .location-switch {
            display: flex;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 20px;
            padding: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .loc-btn {
            padding: 6px 14px;
            font-family: 'Zen Maru Gothic', sans-serif;
            font-size: 12px;
            border: none;
            background: transparent;
            border-radius: 16px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }
        .loc-btn.active {
            background: var(--accent-color);
            color: #fff;
        }

        /* --- „Çø„Ç§„Éà„É´ --- */
        h1 {
            font-size: 16px;
            letter-spacing: 0.4em;
            color: var(--accent-color);
            margin: 0;
            font-family: 'Zen Maru Gothic', sans-serif;
            opacity: 0.8;
        }

        /* --- „É°„Ç§„É≥Ë°®Á§∫„Ç®„É™„Ç¢ --- */
        .display-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        /* Âõ∫ÂÆö„Éï„É¨„Éº„É† */
        .task-frame {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            padding: 20px 0;
        }

        /* ‰∏ä‰∏ã„ÅÆÈ£æ„ÇäÁ∑ö */
        .task-frame::before,
        .task-frame::after {
            content: '';
            position: absolute;
            width: 1px;
            height: 40px;
            background-color: var(--line-color);
            left: 50%;
            transform: translateX(-50%);
        }
        .task-frame::before { top: -20px; }
        .task-frame::after { bottom: -20px; }

        /* „ÉÜ„Ç≠„Çπ„ÉàÊú¨‰Ωì */
        .task-text {
            font-size: 26px;
            line-height: 1.6;
            font-feature-settings: "palt";
            color: #222;
            white-space: nowrap;
            max-height: 60vh;
            overflow: visible;
            z-index: 10;
        }
        
        .task-text.long-text {
            white-space: normal;
            font-size: 20px;
            line-height: 2;
        }

        .message-small {
            font-size: 11px;
            color: #888;
            margin-bottom: 20px;
            font-family: 'Zen Maru Gothic', sans-serif;
        }

        .time-badge {
            font-size: 11px;
            color: #aaa;
            margin-top: 10px;
            font-family: 'Zen Maru Gothic', sans-serif;
            border: 1px solid #eee;
            padding: 4px 8px;
            border-radius: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* --- „Éú„Çø„É≥„Ç®„É™„Ç¢ --- */
        .button-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .btn {
            writing-mode: vertical-rl;
            text-orientation: upright;
            background: transparent;
            color: #333;
            border: 1px solid #333;
            padding: 18px 12px;
            font-size: 13px;
            letter-spacing: 0.2em;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 50px;
            font-family: 'Zen Maru Gothic', sans-serif;
            white-space: nowrap;
        }
        .btn:active { background: #f5f5f5; transform: scale(0.98); }
        .btn-primary { background: #333; color: #fff; border: 1px solid #333; }
        .btn-primary:active { background: #555; }
        
        .btn-night { border-color: #6a5acd; color: #6a5acd; }
        
        .hidden { display: none !important; }

        /* „Çø„Ç§„Éû„Éº */
        #timer-display {
            font-size: 32px;
            letter-spacing: 0.1em;
            color: #222;
            font-feature-settings: "tnum";
        }

        /* --- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ÔºàÊ®™Êõ∏„ÅçÔºâ --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 200;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            writing-mode: horizontal-tb;
        }
        #settings-modal.active { display: flex; }

        .modal-content {
            width: 85%; max-width: 400px; background: #fff; padding: 25px;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #eee;
            max-height: 70vh; display: flex; flex-direction: column;
        }

        .modal-title { font-family:'Zen Maru Gothic'; font-size:16px; margin-bottom:15px; text-align:center; color:#555; }
        
        .tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 12px; color: #aaa; transition:0.3s; }
        .tab.active { color: #5d6c7a; border-bottom: 2px solid #5d6c7a; font-weight: bold; }

        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size:14px; -webkit-appearance: none; }
        #new-task-input { flex: 1; }
        #new-task-time { width: 50px; text-align: center; }
        
        .add-btn { background: #5d6c7a; color: #fff; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; font-size:12px; }
        
        .task-list { flex: 1; overflow-y: auto; border-top: 1px solid #eee; margin-bottom: 15px; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-size:14px; }
        .delete-btn { color: #ccc; cursor: pointer; padding: 0 10px; font-size:18px; }
        
        .close-modal-btn { width: 100%; padding: 12px; background: #f5f5f5; border: none; border-radius: 10px; color: #666; cursor: pointer; }

        .debug-btn { position: fixed; bottom: 10px; right: 10px; writing-mode: horizontal-tb; font-size: 10px; color: #eee; border:none; background:none; cursor: pointer; }

        /* Âç∞Âà∑Áî® */
        #print-area { display: none; }
        @media print {
            body { background: #fff; display: block; writing-mode: vertical-rl; }
            .app-container, .ui-controls, #settings-modal, .debug-btn { display: none; }
            #print-area { display: block; width: 100%; height: 100%; padding: 30px; }
            .book-title-page { height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; border-left: 1px solid #eee; margin-left: 20px; }
            .book-title { font-size: 28px; font-family: 'Hina Mincho', serif; margin-bottom: 20px; text-orientation: upright; }
            .book-date { font-size: 12px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter { height: 90vh; margin-right: 40px; border-left: 1px solid #f0f0f0; padding-left: 20px; display: flex; flex-direction: column; }
            .chapter-header { font-size: 10px; color: #666; margin-bottom: 30px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter-text { font-size: 14px; line-height: 2.2; text-align: justify; font-family: 'Hina Mincho', serif; color: #000; text-orientation: upright; }
            .chapter-footer { margin-top: auto; font-size: 10px; color: #666; text-align: right; text-orientation: upright; }
        }
    </style>
</head>
<body>

    <div class="ui-controls">
        <div class="icon-btn" onclick="openSettings()" title="Ë®≠ÂÆö">‚öô</div>
        <div class="icon-btn" id="sound-toggle" onclick="toggleSound()" title="Èü≥„ÅÆON/OFF">üîá</div>
        
        <div class="location-switch">
            <button class="loc-btn active" id="loc-home" onclick="switchLocation('home')">ÂÆ∂</button>
            <button class="loc-btn" id="loc-out" onclick="switchLocation('out')">Â§ñ</button>
        </div>
    </div>

    <div class="app-container">
        <h1>Â§úÊòé„Åë„ÅÆ„Ç¢„É≥„ÇΩ„É≠„Ç∏„Éº</h1>

        <div id="day-mode" style="display:flex; flex-direction:column; align-items:center; height:100%; width:100%;">
            
            <div id="phase-roulette" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="message-small" id="time-zone-msg"></div>
                
                <div class="display-area">
                    <div class="task-frame">
                        <div id="task-text" class="task-text">„Éö„Éº„Ç∏„Çí„ÇÅ„Åè„Çã</div>
                    </div>
                    <div id="task-time-display" class="time-badge">Ôºà3ÂàÜÔºâ</div>
                </div>
                
                <div class="button-area">
                    <button class="btn" id="btn-spin" onclick="startRoulette()">Êé¢„Åô</button>
                    <button class="btn btn-primary hidden" id="btn-stop-roulette" onclick="stopRoulette()">„Åì„Çå„Å´„Åô„Çã</button>
                    <button class="btn btn-primary hidden" id="btn-start-task" onclick="startFocus()">ÊôÇÈñì„ÇíÁ¥°„Åê</button>
                </div>
            </div>

            <div id="phase-timer" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="message-small" id="timer-message">Èùô„Åã„Å™ÊôÇÈñì</div>
                
                <div class="display-area">
                    <div id="timer-display">00:00</div>
                </div>
                
                <div class="button-area">
                    <button class="btn" onclick="stopFocus()">Ê†û„Çí„ÅØ„Åï„ÇÄ</button>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; color:#aaa; font-family:'Zen Maru Gothic'; letter-spacing:0.1em; flex-shrink:0;">
                <div>Áâ©Ë™ûÔºö<span id="count-display">„Äá</span> ÁØá</div>
            </div>
        </div>

        <div id="night-mode" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
            <div class="display-area">
                <div style="font-size:16px; line-height:2.2; margin-bottom:30px;">
                    ‰ªäÊó•‰∏ÄÊó•„ÄÅ<br>„ÅÇ„Å™„Åü„ÅØÁ¢∫„Åã„Å´Áîü„Åç„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ<br>
                    <span style="font-size:13px; color:#888;">„Åù„ÅÆË®º„Çí„ÄÅ‰∏ÄÂÜä„ÅÆÊú¨„Å´„ÄÇ</span>
                </div>
            </div>
            <div class="button-area">
                <button class="btn btn-night" onclick="printBook()">Ë£ΩÊú¨„Åô„Çã (PDF)</button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">Ë°åÂãï„É™„Çπ„Éà„ÅÆÁ∑®ÈõÜ (<span id="setting-mode-label">ÂÆ∂</span>)</div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('morning')">Êúù</div>
                <div class="tab" onclick="switchTab('day')">Êòº</div>
                <div class="tab" onclick="switchTab('evening')">Â§ï</div>
                <div class="tab" onclick="switchTab('night')">Â§ú</div>
            </div>
            <div class="input-group">
                <input type="text" id="new-task-input" placeholder="Ë°åÂãï„ÇíÂÖ•Âäõ">
                <input type="number" id="new-task-time" placeholder="ÂàÜ" min="0" value="3">
                <button class="add-btn" onclick="addTask()">ËøΩÂä†</button>
            </div>
            <div class="task-list" id="task-list-container"></div>
            <button class="close-modal-btn" onclick="closeSettings()">Èñâ„Åò„Çã</button>
            <div style="margin-top:10px; text-align:center;">
                <button onclick="resetDefaultTasks()" style="background:none; border:none; color:#ccc; text-decoration:underline; cursor:pointer; font-size:11px;">ÂàùÊúü„É™„Çπ„Éà„Å´Êàª„Åô</button>
            </div>
        </div>
    </div>

    <div id="print-area"></div>
    <button class="debug-btn" onclick="forceNightMode()">[DEBUG] Â§ú„Å∏</button>

    <audio id="bgm" loop></audio>

    <script>
        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        const kanjiNums = ['„Äá','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','‰∏É','ÂÖ´','‰πù'];
        function toKanji(num) {
            if (num < 10) return kanjiNums[num];
            const ten = Math.floor(num / 10);
            const one = num % 10;
            return (ten > 1 ? kanjiNums[ten] : '') + 'ÂçÅ' + (one > 0 ? kanjiNums[one] : '');
        }

        // --- ÂàùÊúü„Éá„Éº„Çø ---
        const defaultTasksData = {
            home: {
                morning: [{text:"Ë∂≥„ÅÆÊåá„ÇíÂãï„Åã„Åô",time:1}, {text:"Ê∞¥„Çí‰∏ÄÊùØÈ£≤„ÇÄ",time:1}, {text:"Á™ì„ÇíÈñã„Åë„Çã",time:1}, {text:"È°î„ÇíÊ¥ó„ÅÜ",time:3}, {text:"Ê∑±ÂëºÂê∏„Çí3Âõû",time:1}],
                day: [{text:"Êú∫„ÇíÊã≠„Åè",time:3}, {text:"„É°„Éº„É´1ÈÄö",time:5}, {text:"„Çπ„Éà„É¨„ÉÉ„ÉÅ",time:3}, {text:"„Ç≥„Éº„Éí„ÉºÊ∑π„Çå„Çã",time:5}, {text:"‰∏çË¶Å„Å™Á¥ô„ÇíÊç®„Å¶„Çã",time:3}],
                evening: [{text:"ÁõÆ„ÇíÈñâ„Åò„Å¶‰ºë„ÇÄ",time:3}, {text:"ËÇ©„ÇíÂõû„Åô",time:1}, {text:"„ÅäËå∂„ÇíÈ£≤„ÇÄ",time:5}, {text:"Ê§çÁâ©„Å´Ê∞¥„ÇÑ„Çä",time:2}],
                night: [{text:"‰ªäÊó•„ÇíÊåØ„ÇäËøî„Çã",time:5}, {text:"Â•Ω„Åç„Å™Èü≥Ê•Ω",time:5}, {text:"Ëá™ÂàÜ„ÇíÊä±„Åç„Åó„ÇÅ„Çã",time:1}, {text:"„Çπ„Éû„Éõ„ÇíÁΩÆ„Åè",time:10}]
            },
            out: {
                morning: [{text:"Á©∫„ÅÆËâ≤„ÇíË¶ã„Çã",time:1}, {text:"Ê∑±„ÅèÊÅØ„ÇíÂê∏„ÅÜ",time:1}, {text:"ÂßøÂã¢„ÇíÊ≠£„Åô",time:1}, {text:"‰ªäÊó•„ÅÆ‰∫àÂÆö„ÇíË¶ã„Çã",time:2}],
                day: [{text:"È£≤„ÅøÁâ©„ÇíË≤∑„ÅÜ",time:3}, {text:"„Ç´„Éê„É≥„ÅÆ‰∏≠Êï¥ÁêÜ",time:3}, {text:"ËÉå‰º∏„Å≥„Çí„Åô„Çã",time:1}, {text:"ÈÅ†„Åè„ÇíË¶ã„Çã",time:1}],
                evening: [{text:"Ê≠©„ÅèÈÄüÂ∫¶ËêΩ„Å®„Åô",time:0}, {text:"„Ç∑„Éß„Éº„Ç¶„Ç£„É≥„Éâ„Ç¶",time:3}, {text:"„Éô„É≥„ÉÅ„Åß‰ºë„ÇÄ",time:5}, {text:"Á©∫„ÇíË¶ã‰∏ä„Åí„Çã",time:1}],
                night: [{text:"Êúà„ÇíÊé¢„Åô",time:1}, {text:"ÂÆâÂÖ®„Å´Ê≠©„Åè",time:0}, {text:"‰ªäÊó•„Å´ÊÑüË¨ù„Åô„Çã",time:1}, {text:"Ê∑±ÂëºÂê∏",time:1}]
            }
        };

        const fragments = [
            { theme: "ÂëºÂê∏", text: "Ê∞¥Â∫ï„Å´Ê≤à„Çì„Å†„Çà„ÅÜ„Å´ÊÅØËã¶„Åó„ÅÑÊó•„ÇÇ„ÅÇ„Çã„ÄÇ„Åë„Çå„Å©„ÄÅ„Åì„ÅÜ„Åó„Å¶ÊµÖ„Åè„Å¶„ÇÇÊÅØ„Çí„Åó„Å¶„ÅÑ„Çã„ÄÇ„Åù„Çå„Å†„Åë„Åß„ÄÅÁßÅ„ÅØ‰ªäÊó•„ÇíÁîü„ÅçÊäú„ÅÑ„Åü„ÅÆ„Å†„Å®Ë®Ä„Å£„Å¶„ÅÇ„Åí„Åü„ÅÑ„ÄÇ" },
            { theme: "Ê≥¢Á¥ã", text: "„Åü„Å£„Åü„Å≤„Å®„Å§„ÅÆÂ∞è„Åï„Å™Ë°åÂãï„Åå„ÄÅÊ≥¢Á¥ã„ÅÆ„Çà„ÅÜ„Å´Â∫É„Åå„Å£„Å¶„ÅÑ„Åè„ÄÇ‰ªä„ÅØ„Åæ„Å†Ë¶ã„Åà„Å™„Åè„Å¶„ÇÇ„ÄÅ„Åù„Çå„ÅØÁ¢∫ÂÆü„Å´Êú™Êù•„ÅÆÁßÅ„Å∏„Å®Â±ä„ÅÑ„Å¶„ÅÑ„Çã„ÅØ„Åö„Å†„ÄÇ" },
            { theme: "Èõ®ÂÆø„Çä", text: "Á´ã„Å°Ê≠¢„Åæ„Çã„Åì„Å®„ÅØ„ÄÅÈÄÉ„Åí„Çã„Åì„Å®„Åò„ÇÉ„Å™„ÅÑ„ÄÇÊøÄ„Åó„ÅÑÈõ®„Çí„ÇÑ„ÇäÈÅé„Åî„Åô„Åü„ÇÅ„ÅÆ„ÄÅÂ§ßÂàá„Å™Èõ®ÂÆø„Çä„ÅÆÊôÇÈñì„Å†„ÄÇ„Åì„Åì„ÅßÁæΩÊ†π„Çí‰ºë„ÇÅ„Å¶„ÄÅ„Åæ„ÅüÁ©∫„ÅåÊô¥„Çå„Çã„ÅÆ„ÇíÂæÖ„Å¶„Å∞„ÅÑ„ÅÑ„ÄÇ" },
            { theme: "ÁÅØÁÅ´", text: "Ë™∞„Å´„ÇÇÊ∞ó„Å•„Åã„Çå„Å™„ÅÑ„Çà„ÅÜ„Å™Â†¥ÊâÄ„Åß„ÄÅÁßÅ„ÅØÁßÅ„ÅÆ„Åü„ÇÅ„ÅÆÁÅØ„Çä„Çí„Å®„ÇÇ„Åô„ÄÇ„Åì„ÅÆÂ∞è„Åï„Å™Ê∏©„Åã„Åï„Åå„ÅÇ„Çå„Å∞„ÄÅÊöó„ÅÑÂ§ú„ÇÇÊÄñ„Åè„ÅØ„Å™„ÅÑ„ÄÇ" },
            { theme: "ÂõûÂæ©", text: "ÂÇ∑„Å§„ÅÑ„ÅüÂøÉ„ÅåÂÖÉ„Å´Êàª„Çã„Å´„ÅØÊôÇÈñì„Åå„Åã„Åã„Çã„ÄÇ„Å†„Åã„ÇâÁÑ¶„Çâ„Å™„Åè„Å¶„ÅÑ„ÅÑ„ÄÇ„ÇÜ„Å£„Åè„Çä„Å®„ÄÅËñÑÁ¥ô„ÇíÂâ•„Åê„Çà„ÅÜ„Å´„ÄÅÁßÅ„ÅØÁßÅ„ÇíÂèñ„ÇäÊàª„Åó„Å¶„ÅÑ„Åè„ÄÇ" },
            { theme: "ÊôÇÈñì", text: "ÊµÅ„Çå„ÇãÊôÇÈñì„Å´ËøΩ„Çè„Çå„ÇãÂøÖË¶Å„ÅØ„Å™„ÅÑ„ÄÇÁßÅ„ÅØ„Åü„Å†„ÄÅËá™ÂàÜ„ÅÆÂëºÂê∏„ÅÆÈÄüÂ∫¶„Åß„ÄÅ„Åì„ÅÆ‰∏ÄÁû¨„ÇíÂë≥„Çè„Åà„Å∞„ÅÑ„ÅÑ„ÅÆ„Å†„ÄÇ" }
        ];

        // --- Áä∂ÊÖãÂ§âÊï∞ ---
        let tasksData = {};
        let collectedData = [];
        let currentMode = 'home'; 
        let currentTab = 'morning'; 
        let currentZone = 'morning';
        let rouletteInterval;
        let timerInterval;
        let totalSeconds = 180;
        let currentTaskObj = null;
        let isSoundOn = false;
        
        const bgm = document.getElementById('bgm');
        bgm.src = "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"; 
        bgm.volume = 0.2;

        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadData();
            checkTime();
            updateCount();
            switchLocation('home');
            updateSoundIcon();
        });

        // --- Ê©üËÉΩÁæ§ ---

        function toggleSound() {
            isSoundOn = !isSoundOn;
            if(!isSoundOn) {
                bgm.pause();
            }
            updateSoundIcon();
        }

        function updateSoundIcon() {
            const btn = document.getElementById('sound-toggle');
            if(isSoundOn) {
                btn.textContent = "üîä";
                btn.classList.add('active');
            } else {
                btn.textContent = "üîá";
                btn.classList.remove('active');
            }
        }

        function playBGM() {
            if(isSoundOn) {
                bgm.play().catch(() => {});
            }
        }

        function stopBGM() {
            bgm.pause();
        }

        function switchLocation(mode) {
            currentMode = mode;
            document.querySelectorAll('.loc-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('loc-' + mode).classList.add('active');
            checkTime();
        }

        function checkTime() {
            const hour = new Date().getHours();
            if (hour >= 23) {
                showNightMode();
                return;
            } else {
                showDayMode();
            }

            let msg = "";
            if (hour >= 6 && hour < 10) { 
                currentZone = 'morning'; 
                msg = (currentMode === 'home') ? "Êúù„ÅÆÂÖâ„ÅÆ‰∏≠„Åß„ÄÅÂ∞è„Åï„ÅèÂßã„ÇÅ„Çã„ÄÇ" : "Êñ∞„Åó„ÅÑ‰∏ÄÊ≠©„Çí„ÄÅÂ§ñ„ÅÆ‰∏ñÁïå„Å∏„ÄÇ";
            } else if (hour >= 10 && hour < 14) { 
                currentZone = 'day'; 
                msg = (currentMode === 'home') ? "Êó•‰∏≠„ÅÆÂñßÈ®í„Åã„Çâ„ÄÅÂ∞ë„ÅóÈõ¢„Çå„Å¶„ÄÇ" : "È¢®„ÇíÊÑü„Åò„Å¶„ÄÅÂøÉ„ÇíËªΩ„Åè„ÄÇ";
            } else if (hour >= 14 && hour < 18) { 
                currentZone = 'evening'; 
                msg = (currentMode === 'home') ? "Â§ïÊöÆ„ÇåÊôÇ„ÄÅÂøÉ„ÇíÊï¥„Åà„Çã„ÄÇ" : "Â∏∞„ÇäÈÅì„ÄÅËá™ÂàÜ„ÇíÂä¥„ÅÜ„ÄÇ";
            } else if (hour >= 18 && hour < 23) { 
                currentZone = 'night'; 
                msg = (currentMode === 'home') ? "Â§ú„ÅÆÈùôÂØÇ„Å´„ÄÅË∫´„ÇíÂßî„Å≠„Å¶„ÄÇ" : "Â§úÈ¢®„Å®ÂÖ±„Å´„ÄÅÈùô„Åã„Å´Â∏∞„Çã„ÄÇ";
            } else { 
                currentZone = 'morning'; 
                msg = "Èùô„Åã„Å™Âàª„Å´„ÄÅËÄ≥„ÇíÊæÑ„Åæ„Åô„ÄÇ"; 
            }
            
            const msgEl = document.getElementById('time-zone-msg');
            if(msgEl) msgEl.innerText = msg;
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            const label = document.getElementById('setting-mode-label');
            if(label) label.innerText = (currentMode === 'home' ? "ÂÆ∂" : "Â§ñ");
            switchTab(currentZone || 'morning');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        function switchTab(zone) {
            currentTab = zone;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${zone}')"]`).classList.add('active');
            renderTaskList();
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = "";
            const list = tasksData[currentMode][currentTab] || [];
            
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `
                    <div class="task-info">
                        <span>${item.text}</span>
                        <span style="font-size:10px; color:#aaa; margin-left:5px;">(${item.time}ÂàÜ)</span>
                    </div>
                    <span class="delete-btn" onclick="deleteTask(${index})">√ó</span>
                `;
                container.appendChild(div);
            });
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const timeInput = document.getElementById('new-task-time');
            const val = input.value.trim();
            const t = parseInt(timeInput.value);
            
            if (val && t >= 0) {
                if(!tasksData[currentMode]) tasksData[currentMode] = {};
                if(!tasksData[currentMode][currentTab]) tasksData[currentMode][currentTab] = [];
                
                tasksData[currentMode][currentTab].push({ text: val, time: t });
                saveTasks();
                renderTaskList();
                input.value = ""; 
                timeInput.value = "3";
            }
        }

        function deleteTask(index) {
            if(tasksData[currentMode] && tasksData[currentMode][currentTab]) {
                tasksData[currentMode][currentTab].splice(index, 1);
                saveTasks();
                renderTaskList();
            }
        }

        function resetDefaultTasks() {
            if(confirm("ÁèæÂú®„ÅÆ„É¢„Éº„Éâ„ÅÆ„É™„Çπ„Éà„ÇíÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü")) {
                tasksData = JSON.parse(JSON.stringify(defaultTasksData));
                saveTasks();
                renderTaskList();
            }
        }

        function loadTasks() {
            const stored = localStorage.getItem('location_tasks_v31');
            if (stored) { 
                tasksData = JSON.parse(stored); 
            } else { 
                tasksData = JSON.parse(JSON.stringify(defaultTasksData)); 
            }
        }

        function saveTasks() {
            localStorage.setItem('location_tasks_v31', JSON.stringify(tasksData));
        }

        function startRoulette() {
            checkTime();
            const list = tasksData[currentMode][currentZone];
            
            if(!list || list.length === 0) {
                alert("„É™„Çπ„Éà„ÅåÁ©∫„Åß„Åô„ÄÇË®≠ÂÆö„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }
            
            document.getElementById('btn-spin').classList.add('hidden');
            document.getElementById('btn-stop-roulette').classList.remove('hidden');
            document.getElementById('task-time-display').style.opacity = 0;
            
            const textBox = document.getElementById('task-text');
            textBox.classList.remove('long-text');

            rouletteInterval = setInterval(() => {
                const r = Math.floor(Math.random() * list.length);
                const txt = list[r].text;
                textBox.innerText = txt;
                if(txt.length > 8) textBox.classList.add('long-text');
                else textBox.classList.remove('long-text');
            }, 70);
        }

        function stopRoulette() {
            clearInterval(rouletteInterval);
            const list = tasksData[currentMode][currentZone];
            const r = Math.floor(Math.random() * list.length);
            
            currentTaskObj = list[r];
            const textBox = document.getElementById('task-text');
            textBox.innerText = currentTaskObj.text;
            
            if(currentTaskObj.text.length > 8) {
                textBox.classList.add('long-text');
            } else {
                textBox.classList.remove('long-text');
            }
            
            const timeDisplay = document.getElementById('task-time-display');
            timeDisplay.innerText = `Ôºà${currentTaskObj.time}ÂàÜÔºâ`;
            timeDisplay.style.opacity = 1;
            
            playSoftSound();
            document.getElementById('btn-stop-roulette').classList.add('hidden');
            document.getElementById('btn-start-task').classList.remove('hidden');
        }

        function startFocus() {
            document.getElementById('phase-roulette').classList.add('hidden');
            document.getElementById('phase-timer').classList.remove('hidden');
            document.getElementById('timer-message').innerText = `„Äå${currentTaskObj.text}„Äç„ÅÆÊôÇÈñì`;
            
            playBGM();
            
            totalSeconds = currentTaskObj.time * 60;
            if(totalSeconds <= 0) {
                 completeTask();
                 return;
            }
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                totalSeconds--;
                updateTimerDisplay();
                if(totalSeconds <= 0) completeTask();
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            const mStr = m.toString().padStart(2, '0');
            const sStr = s.toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${mStr}:${sStr}`;
        }

        function stopFocus() {
            clearInterval(timerInterval);
            stopBGM();
            resetPhase();
        }

        function completeTask() {
            clearInterval(timerInterval);
            stopBGM();
            
            const rand = Math.floor(Math.random() * fragments.length);
            const fragment = fragments[rand];
            
            collectedData.push({
                date: new Date(),
                action: currentTaskObj.text,
                content: fragment
            });
            saveData();
            updateCount();
            alert("Áâ©Ë™û„ÅÆÊ¨†Áâá„ÇíË¶ã„Å§„Åë„Åæ„Åó„Åü„ÄÇ");
            resetPhase();
        }

        function resetPhase() {
            document.getElementById('phase-timer').classList.add('hidden');
            document.getElementById('phase-roulette').classList.remove('hidden');
            document.getElementById('btn-start-task').classList.add('hidden');
            document.getElementById('btn-spin').classList.remove('hidden');
            
            const textBox = document.getElementById('task-text');
            textBox.innerText = "„Éö„Éº„Ç∏„Çí„ÇÅ„Åè„Çã";
            textBox.classList.remove('long-text');
            
            document.getElementById('task-time-display').style.opacity = 0;
        }

        function showDayMode() {
            document.getElementById('day-mode').classList.remove('hidden');
            document.getElementById('night-mode').classList.add('hidden');
        }

        function showNightMode() {
            document.getElementById('day-mode').classList.add('hidden');
            document.getElementById('night-mode').classList.remove('hidden');
        }

        function forceNightMode() { showNightMode(); }

        function updateCount() {
            document.getElementById('count-display').innerText = toKanji(collectedData.length);
        }

        function saveData() {
            localStorage.setItem('anthology_data_v31', JSON.stringify(collectedData));
        }

        function loadData() {
            const data = localStorage.getItem('anthology_data_v31');
            if(data) {
                collectedData = JSON.parse(data);
                collectedData.forEach(d => d.date = new Date(d.date));
            }
        }

        function playSoftSound() {
            if(!isSoundOn) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }

        function printBook() {
            if(collectedData.length === 0) {
                alert("ÁôΩÁ¥ô„Åß„Åô„ÄÇ");
                return;
            }
            const printArea = document.getElementById('print-area');
            const now = new Date();
            const dateStr = `${toKanji(now.getFullYear())}Âπ¥ ${toKanji(now.getMonth()+1)}Êúà ${toKanji(now.getDate())}Êó•`;
            let html = `<div class="book-title-page"><div class="book-title">Â§úÊòé„Åë„ÅÆ„Ç¢„É≥„ÇΩ„É≠„Ç∏„Éº</div><div class="book-date">${dateStr}</div></div>`;
            
            collectedData.forEach(item => {
                const h = new Date(item.date).getHours();
                const m = new Date(item.date).getMinutes();
                html += `<div class="chapter"><div class="chapter-header">Ë©¶„ÅøÔºö${item.action}</div><div class="chapter-text">${item.content.text}</div><div class="chapter-footer">‚Äï ${item.content.theme}</div></div>`;
            });
            
            printArea.innerHTML = html;
            window.print();
        }
    </script>
</body>
</html>
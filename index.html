<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>夜明けのアンソロジー</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fcfaf2">

    <link href="https://fonts.googleapis.com/css2?family=Hina+Mincho&family=Zen+Maru+Gothic:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --grid-size: 40px; 
            --font-size: 22px; 
            --transition-speed: 0.5s;
        }

        body[data-mode="home"] {
            --paper-color: #fcfaf2;
            --grid-color: rgba(100, 140, 100, 0.2);
            --text-color: #2b2b2b;
            --accent-color: #5d6c7a;
            --btn-text: #444;
        }

        body[data-mode="out"] {
            --paper-color: #1a1a1a;
            --grid-color: rgba(255, 255, 255, 0.15);
            --text-color: #e0e0e0;
            --accent-color: #a8b8c0;
            --btn-text: #ccc;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--paper-color);
            color: var(--text-color);
            font-family: 'Hina Mincho', serif;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            writing-mode: vertical-rl; text-orientation: upright;
            overflow: hidden; overscroll-behavior: none;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            background-image: 
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            background-position: center center;
            position: relative;
        }

        .app-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between;
            padding: 30px; box-sizing: border-box;
            background: transparent; pointer-events: none;
        }
        .app-container > * { pointer-events: auto; }

        .display-area {
            flex-grow: 1; width: 100%;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            writing-mode: horizontal-tb; 
        }

        .task-text {
            writing-mode: vertical-rl; text-orientation: upright;
            font-size: var(--font-size); line-height: var(--grid-size);
            letter-spacing: 0.3em; color: var(--text-color);
            font-feature-settings: "palt"; white-space: nowrap; 
            max-height: 80vh; margin: 0 auto;
            text-shadow: 0 0 1px rgba(0,0,0,0.05);
            transition: color var(--transition-speed);
        }
        
        .task-text.long-text { white-space: pre-wrap; margin-left: -20px; }

        .time-badge {
            position: absolute; bottom: 20px; left: 20px;
            writing-mode: horizontal-tb; font-size: 11px;
            color: var(--text-color); opacity: 0.6;
            font-family: 'Zen Maru Gothic', sans-serif;
            transition: opacity 0.5s;
        }

        #time-zone-msg, #timer-message {
            position: absolute; top: 0; right: 0;
            writing-mode: vertical-rl; font-size: 12px; 
            color: var(--text-color); opacity: 0.5;
            font-family: 'Zen Maru Gothic', sans-serif; white-space: nowrap;
        }

        .ui-controls {
            position: absolute; top: 20px; left: 20px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 100; writing-mode: horizontal-tb;
        }

        .icon-btn {
            width: 40px; height: 40px; background: transparent; border: none;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Hina Mincho', serif; font-size: 20px;
            cursor: pointer; color: var(--text-color); opacity: 0.4;
            transition: opacity 0.3s;
        }
        .icon-btn:hover { opacity: 1; }
        .icon-btn.active { opacity: 1; font-weight: bold; }

        .location-switch { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .loc-btn {
            width: 40px; height: 40px; padding: 0;
            font-family: 'Hina Mincho', serif; font-size: 16px;
            border: none; background: transparent; cursor: pointer;
            color: var(--text-color); opacity: 0.3; transition: all 0.3s;
        }
        .loc-btn.active { opacity: 1; font-weight: bold; border-left: 2px solid var(--accent-color); }

        .button-area {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            margin-left: 10px; z-index: 50;
        }

        .btn {
            writing-mode: vertical-rl; text-orientation: upright;
            background: transparent; color: var(--text-color);
            border: none; padding: 15px 10px; font-size: 16px;
            letter-spacing: 0.3em; cursor: pointer; transition: all 0.3s;
            font-family: 'Hina Mincho', serif; white-space: nowrap; opacity: 0.6;
        }
        .btn:hover { opacity: 1; transform: scale(1.05); }
        .btn:active { opacity: 0.4; transform: scale(0.95); }
        .btn-night { color: var(--accent-color); opacity: 1; font-weight: bold; }
        .btn-cancel { font-size: 14px; opacity: 0.4; padding: 10px; }
        .btn-cancel:hover { opacity: 0.7; }

        .hidden { display: none !important; }

        #timer-display {
            font-size: 32px; line-height: var(--grid-size);
            color: var(--text-color); font-feature-settings: "tnum";
            font-family: 'Hina Mincho', serif;
            writing-mode: vertical-rl; text-orientation: upright;
        }

        /* --- 設定モーダル --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 200;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
            writing-mode: horizontal-tb; flex-direction: column;
        }
        #settings-modal.active { display: flex; }

        .settings-content {
            width: 85%; max-width: 400px; background: var(--paper-color);
            color: var(--text-color); padding: 25px; border-radius: 4px; 
            border: 1px solid var(--grid-color); box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-height: 85vh; display: flex; flex-direction: column;
            transition: background-color var(--transition-speed);
        }

        /* --- 読書画面（横スライド・スナップ対応版） --- */
        #reader-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--paper-color); /* 紙の色 */
            z-index: 200;
            
            /* グリッド背景 */
            background-image: linear-gradient(to right, var(--grid-color) 1px, transparent 1px), linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            background-position: center center;
            
            display: none;
            flex-direction: column; /* 縦並び（閉じるボタンを下に置くため） */
            
            /* 全体の書き方向をリセット */
            writing-mode: horizontal-tb;
        }
        #reader-modal.active { display: flex; }
        
        .reader-content {
            flex-grow: 1; /* 残りのスペースを埋める */
            width: 100%;
            
            /* 横スクロール設定 */
            display: flex;
            flex-direction: row; /* 横並び */
            overflow-x: auto;
            overflow-y: hidden;
            
            /* スナップ設定 */
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            
            align-items: center; /* 上下中央 */
            padding: 0 10vw; /* 左右に少し余白 */
            box-sizing: border-box;
            
            /* 右から左へ並べる設定（dir="rtl" はHTML側で制御） */
        }
        
        /* 1つの物語カード */
        .reader-entry {
            /* サイズ固定・スナップ */
            flex: 0 0 80vw; /* 画面幅の80% */
            height: 70vh;   /* 画面高さの70% */
            scroll-snap-align: center;
            
            margin: 0 15px;
            padding: 20px;
            box-sizing: border-box;
            
            /* カードのデザイン */
            border: 1px solid var(--accent-color);
            background: rgba(255,255,255,0.1); /* ほんのり背景 */
            
            /* 中身は縦書き */
            writing-mode: vertical-rl;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .reader-action { 
            font-size: 14px; opacity: 0.6; 
            margin-bottom: 10px; 
            font-family: 'Zen Maru Gothic', sans-serif; 
            flex-shrink: 0;
        }
        
        .reader-text { 
            font-size: var(--font-size); 
            line-height: var(--grid-size); 
            letter-spacing: 0.2em; 
            overflow-y: auto; /* 長文時は縦書きスクロール */
            flex-grow: 1;
        }
        
        .reader-date { 
            font-size: 12px; 
            margin-top: 20px; 
            text-align: right; 
            opacity: 0.4; 
            font-family: 'Zen Maru Gothic', sans-serif; 
            flex-shrink: 0;
        }
        
        .reader-close-area {
            height: 100px; /* ボタンエリア確保 */
            width: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0;
        }
        
        .reader-close-btn {
            background: var(--paper-color); 
            padding: 12px 30px;
            border: 1px solid var(--grid-color);
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer; color: var(--text-color);
            font-family: 'Hina Mincho', serif;
            font-size: 15px; letter-spacing: 0.1em;
        }

        .input-group { display: flex; gap: 8px; margin-bottom: 20px; align-items: center; width: 100%; }
        #new-task-input { flex: 1; padding: 10px; border: 1px solid var(--grid-color); background: transparent; color: var(--text-color); border-radius: 2px; font-size: 14px; font-family: 'Hina Mincho'; min-width: 0; }
        #new-task-time { width: 50px; flex-shrink: 0; padding: 10px 5px; text-align: center; border: 1px solid var(--grid-color); background: transparent; color: var(--text-color); border-radius: 2px; font-size: 14px; font-family: 'Hina Mincho'; }
        .add-btn { flex-shrink: 0; background: var(--accent-color); color: #fff; border: none; padding: 10px 15px; border-radius: 2px; cursor: pointer; font-size: 13px; white-space: nowrap; }
        .modal-title { font-family:'Hina Mincho'; font-size:18px; margin-bottom:20px; text-align:center; }
        .tabs { display: flex; border-bottom: 1px solid var(--grid-color); margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 13px; opacity: 0.5; }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--accent-color); font-weight: bold; }
        .task-list { flex: 1; overflow-y: auto; border-top: 1px solid var(--grid-color); margin-bottom: 20px; min-height: 100px;}
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--grid-color); font-size:15px; font-family:'Hina Mincho'; }
        .close-modal-btn { width: 100%; padding: 12px; background: transparent; border: 1px solid var(--grid-color); color: var(--text-color); cursor: pointer; font-family:'Hina Mincho'; border-radius:2px; }
        .delete-btn { opacity: 0.5; cursor: pointer; padding: 0 10px; }
        .menu-btn { width: 100%; padding: 12px; text-align:left; background: transparent; border: none; color: var(--text-color); cursor: pointer; font-family:'Hina Mincho'; font-size:14px; display:flex; justify-content:space-between; opacity:0.8; }
        .divider { border-bottom: 1px solid var(--grid-color); margin: 20px 0; width: 100%; opacity: 0.5; }
        .debug-btn { position: fixed; bottom: 10px; right: 10px; writing-mode: horizontal-tb; font-size: 10px; color: var(--grid-color); border:none; background:none; cursor: pointer; }

        #print-area { display: none; }
        @media print {
            body { background: #fff !important; color: #000 !important; background-image: none !important; }
            .app-container, .ui-controls, .debug-btn { display: none; }
            #print-area { display: block; width: 100%; height: 100%; padding: 30px; }
            .book-page { border-right: 1px solid #ddd; padding-right: 20px; height: 100%; }
            .book-title { font-size: 28px; font-family: 'Hina Mincho', serif; margin-bottom: 20px; text-orientation: upright; }
            .book-date { font-size: 12px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter { height: 90vh; margin-right: 40px; border-left: 1px solid #999; padding-left: 20px; display: flex; flex-direction: column; }
            .chapter-header { font-size: 10px; color: #666; margin-bottom: 30px; font-family: 'Zen Maru Gothic', sans-serif; text-orientation: upright; }
            .chapter-text { font-size: 16px; line-height: 2.5; text-align: justify; font-family: 'Hina Mincho', serif; color: #000; text-orientation: upright; }
            .chapter-footer { margin-top: auto; font-size: 10px; color: #666; text-align: right; text-orientation: upright; }
        }
    </style>
</head>
<body data-mode="home">

    <div class="ui-controls">
        <button class="icon-btn" onclick="openSettings()" title="設定">設</button>
        <button class="icon-btn" id="sound-toggle" onclick="toggleSound()" title="音のON/OFF">音</button>
        <button class="icon-btn" onclick="openReader()" title="本棚">棚</button>
        
        <div class="location-switch">
            <button class="loc-btn active" id="loc-home" onclick="switchLocation('home')">家</button>
            <button class="loc-btn" id="loc-out" onclick="switchLocation('out')">外</button>
        </div>
    </div>

    <div class="app-container">
        <div id="day-mode" style="display:flex; flex-direction:column; align-items:center; height:100%; width:100%;">
            <div id="phase-roulette" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="display-area">
                    <div id="time-zone-msg"></div>
                    <div id="task-text" class="task-text">ページをめくる</div>
                    <div id="task-time-display" class="time-badge"></div>
                </div>
                <div class="button-area">
                    <button class="btn" id="btn-spin" onclick="startRoulette()">探す</button>
                    <button class="btn hidden" id="btn-stop-roulette" onclick="stopRoulette()">此処にする</button>
                    <button class="btn hidden" id="btn-start-task" onclick="startFocus()">時間を紡ぐ</button>
                    <button class="btn btn-cancel hidden" id="btn-cancel-task" onclick="resetPhase()">紡がない</button>
                </div>
            </div>

            <div id="phase-timer" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center; width:100%;">
                <div class="display-area">
                    <div id="timer-message">静かな時間</div>
                    <div id="timer-display">00:00</div>
                </div>
                <div class="button-area">
                    <button class="btn" onclick="stopFocus()">栞をはさむ</button>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; font-family:'Zen Maru Gothic'; letter-spacing:0.1em; flex-shrink:0; opacity:0.6;">
                <div>物語：<span id="count-display">〇</span> 篇</div>
            </div>
        </div>

        <div id="night-mode" class="hidden" style="display:flex; flex-direction:column; align-items:center; height:100%; justify-content:center;">
            <div class="display-area">
                <div class="task-text" style="font-size:20px;">
                    今日一日、<br>あなたは確かに生きていました。<br>
                    <span style="font-size:14px; opacity:0.6;">その証を、一冊の本に。</span>
                </div>
            </div>
            <div class="button-area">
                <button class="btn btn-night" onclick="openReader()">立ち読み</button>
                <button class="btn btn-night" onclick="printBook()">製本する</button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="settings-content">
            <div class="modal-title">行動リストの編集</div>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('morning')">朝</div>
                <div class="tab" onclick="switchTab('day')">昼</div>
                <div class="tab" onclick="switchTab('evening')">夕</div>
                <div class="tab" onclick="switchTab('night')">夜</div>
            </div>
            <div class="input-group">
                <input type="text" id="new-task-input" placeholder="行動を入力">
                <input type="number" id="new-task-time" placeholder="分" min="0" value="3">
                <button class="add-btn" onclick="addTask()">追加</button>
            </div>
            <div class="task-list" id="task-list-container"></div>
            <div class="divider"></div>
            <div style="margin-bottom:20px;">
                <button class="menu-btn" onclick="forceNightMode(); closeSettings();">
                    <span>夜の部屋へ（製本・立ち読み）</span><span>☾</span>
                </button>
                <button class="menu-btn" onclick="resetStory()">
                    <span>物語をリセットする</span><span>↺</span>
                </button>
                <button class="menu-btn" onclick="resetDefaultTasks()">
                    <span>リストを初期状態に戻す</span><span>⚠</span>
                </button>
            </div>
            <button class="close-modal-btn" onclick="closeSettings()">閉じる</button>
        </div>
    </div>

    <div id="reader-modal">
        <div class="reader-content" id="reader-content" dir="rtl"></div>
        <div class="reader-close-area">
            <button class="reader-close-btn" onclick="closeReader()">× 閉じる</button>
        </div>
    </div>

    <div id="print-area"></div>
    <audio id="bgm" loop></audio>

    <script>
        const kanjiNums = ['〇','一','二','三','四','五','六','七','八','九'];
        function toKanji(num) {
            if (num < 10) return kanjiNums[num];
            const ten = Math.floor(num / 10);
            const one = num % 10;
            return (ten > 1 ? kanjiNums[ten] : '') + '十' + (one > 0 ? kanjiNums[one] : '');
        }

        const defaultTasksData = {
            home: {
                morning: [{text:"足の指を動かす",time:1}, {text:"水を一杯飲む",time:1}, {text:"窓を開ける",time:1}, {text:"顔を洗う",time:3}, {text:"深呼吸を3回",time:1}],
                day: [{text:"机を拭く",time:3}, {text:"メール1通",time:5}, {text:"ストレッチ",time:3}, {text:"コーヒー淹れる",time:5}, {text:"不要な紙を捨てる",time:3}],
                evening: [{text:"目を閉じて休む",time:3}, {text:"肩を回す",time:1}, {text:"お茶を飲む",time:5}, {text:"植物に水やり",time:2}],
                night: [{text:"今日を振り返る",time:5}, {text:"好きな音楽",time:5}, {text:"自分を抱きしめる",time:1}, {text:"スマホを置く",time:10}]
            },
            out: {
                morning: [{text:"空の色を見る",time:1}, {text:"深く息を吸う",time:1}, {text:"姿勢を正す",time:1}, {text:"今日の予定を見る",time:2}],
                day: [{text:"飲み物を買う",time:3}, {text:"カバンの中整理",time:3}, {text:"背伸びをする",time:1}, {text:"遠くを見る",time:1}],
                evening: [{text:"歩く速度落とす",time:0}, {text:"ショーウィンドウ",time:3}, {text:"ベンチで休む",time:5}, {text:"空を見上げる",time:1}],
                night: [{text:"月を探す",time:1}, {text:"安全に歩く",time:0}, {text:"今日に感謝する",time:1}, {text:"深呼吸",time:1}]
            }
        };

        const fragments = [
            { theme: "呼吸", text: "水底に沈んだように息苦しい日もある。けれど、こうして浅くても息をしている。それだけで、私は今日を生き抜いたのだと言ってあげたい。" },
            { theme: "波紋", text: "たったひとつの小さな行動が、波紋のように広がっていく。今はまだ見えなくても、それは確実に未来の私へと届いているはずだ。" },
            { theme: "雨宿り", text: "立ち止まることは、逃げることじゃない。激しい雨をやり過ごすための、大切な雨宿りの時間だ。ここで羽根を休めて、また空が晴れるのを待てばいい。" },
            { theme: "灯火", text: "誰にも気づかれないような場所で、私は私のための灯りをともす。この小さな温かさがあれば、暗い夜も怖くはない。" },
            { theme: "回復", text: "傷ついた心が元に戻るには時間がかかる。だから焦らなくていい。ゆっくりと、薄紙を剥ぐように、私は私を取り戻していく。" },
            { theme: "時間", text: "流れる時間に追われる必要はない。私はただ、自分の呼吸の速度で、この一瞬を味わえばいいのだ。" }
        ];

        let tasksData = {};
        let collectedData = [];
        let currentMode = 'home'; 
        let currentTab = 'morning'; 
        let currentZone = 'morning';
        let rouletteInterval;
        let timerInterval;
        let totalSeconds = 180;
        let currentTaskObj = null;
        let isSoundOn = false;
        let endTime; 
        
        const bgm = document.getElementById('bgm');
        bgm.src = "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3"; 
        bgm.volume = 0.2;

        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            loadData();
            checkDateChange(); 
            checkTime();
            updateCount();
            switchLocation('home');
            updateSoundIcon();
        });

        // 日付変更チェック（物語リセット）
        function checkDateChange() {
            const lastDate = localStorage.getItem('anthology_last_date');
            const todayStr = new Date().toDateString();
            
            if (lastDate && lastDate !== todayStr) {
                collectedData = [];
                saveData();
                console.log("Date changed. Story reset.");
            }
            localStorage.setItem('anthology_last_date', todayStr);
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            if(!isSoundOn) bgm.pause();
            updateSoundIcon();
        }

        function updateSoundIcon() {
            const btn = document.getElementById('sound-toggle');
            if(isSoundOn) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        function playBGM() {
            if(isSoundOn) bgm.play().catch(() => {});
        }

        function stopBGM() { bgm.pause(); }

        function switchLocation(mode) {
            currentMode = mode;
            document.body.setAttribute('data-mode', mode);
            document.querySelectorAll('.loc-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('loc-' + mode).classList.add('active');
            checkTime();
        }

        function checkTime() {
            const hour = new Date().getHours();
            if (hour >= 23) { showNightMode(); return; } 
            else { showDayMode(); }

            let msg = "";
            if (hour >= 6 && hour < 10) currentZone = 'morning';
            else if (hour >= 10 && hour < 14) currentZone = 'day';
            else if (hour >= 14 && hour < 18) currentZone = 'evening';
            else if (hour >= 18 && hour < 23) currentZone = 'night';
            else currentZone = 'morning'; 
            
            const msgs = {
                morning: (currentMode === 'home') ? "朝の光の中で、小さく始める。" : "新しい一歩を、外の世界へ。",
                day: (currentMode === 'home') ? "日中の喧騒から、少し離れて。" : "風を感じて、心を軽く。",
                evening: (currentMode === 'home') ? "夕暮れ時、心を整える。" : "帰り道、自分を労う。",
                night: (currentMode === 'home') ? "夜の静寂に、身を委ねて。" : "夜風と共に、静かに帰る。"
            };
            
            const msgEl = document.getElementById('time-zone-msg');
            if(msgEl) msgEl.innerText = msgs[currentZone];
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            const label = document.getElementById('setting-mode-label');
            if(label) label.innerText = (currentMode === 'home' ? "家" : "外");
            switchTab(currentZone || 'morning');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        // --- 読書画面を開く ---
        function openReader() {
            if(collectedData.length === 0) { alert("まだ白紙です。"); return; }
            const container = document.getElementById('reader-content');
            let html = '';
            
            // RTLなので、配列順（古い順）に追加すれば、右側（先頭）に古いものが来る
            collectedData.forEach(item => {
                const h = new Date(item.date).getHours();
                const m = new Date(item.date).getMinutes();
                const timeStr = `${toKanji(h)}時${toKanji(m)}分`;
                
                html += `
                    <div class="reader-entry">
                        <div class="reader-action">「${item.action}」ノ時</div>
                        <div class="reader-text">${item.content.text}</div>
                        <div class="reader-date">（${timeStr}）</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            document.getElementById('reader-modal').classList.add('active');
        }

        function closeReader() {
            document.getElementById('reader-modal').classList.remove('active');
        }

        function switchTab(zone) {
            currentTab = zone;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${zone}')"]`).classList.add('active');
            renderTaskList();
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            container.innerHTML = "";
            const list = tasksData[currentMode][currentTab] || [];
            
            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'task-item';
                div.innerHTML = `<div class="task-info"><span>${item.text}</span><span style="font-size:10px; opacity:0.6; margin-left:5px;">(${item.time}分)</span></div><span class="delete-btn" onclick="deleteTask(${index})">×</span>`;
                container.appendChild(div);
            });
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const timeInput = document.getElementById('new-task-time');
            const val = input.value.trim();
            const t = parseInt(timeInput.value);
            if (val && t >= 0) {
                if(!tasksData[currentMode]) tasksData[currentMode] = {};
                if(!tasksData[currentMode][currentTab]) tasksData[currentMode][currentTab] = [];
                tasksData[currentMode][currentTab].push({ text: val, time: t });
                saveTasks();
                renderTaskList();
                input.value = ""; timeInput.value = "3";
            }
        }

        function deleteTask(index) {
            if(tasksData[currentMode] && tasksData[currentMode][currentTab]) {
                tasksData[currentMode][currentTab].splice(index, 1);
                saveTasks();
                renderTaskList();
            }
        }

        function resetDefaultTasks() {
            if(confirm("リストを初期状態に戻しますか？")) {
                tasksData = JSON.parse(JSON.stringify(defaultTasksData));
                saveTasks();
                renderTaskList();
            }
        }
        
        function resetStory() {
            if(confirm("今日の物語をリセットしますか？\n（これまでの記録は消えます）")) {
                collectedData = [];
                saveData();
                updateCount();
                alert("新しい白紙を用意しました。");
                closeSettings();
            }
        }

        function loadTasks() {
            const stored = localStorage.getItem('location_tasks_v52');
            if (stored) { tasksData = JSON.parse(stored); } 
            else { tasksData = JSON.parse(JSON.stringify(defaultTasksData)); }
        }

        function saveTasks() { localStorage.setItem('location_tasks_v52', JSON.stringify(tasksData)); }

        function startRoulette() {
            checkTime();
            const list = tasksData[currentMode][currentZone];
            if(!list || list.length === 0) { alert("リストが空です。設定から追加してください。"); return; }
            
            document.getElementById('btn-spin').classList.add('hidden');
            document.getElementById('btn-stop-roulette').classList.remove('hidden');
            document.getElementById('task-time-display').style.opacity = 0;
            const textBox = document.getElementById('task-text');
            textBox.innerText = "";
            textBox.classList.remove('long-text');

            rouletteInterval = setInterval(() => {
                const r = Math.floor(Math.random() * list.length);
                textBox.innerText = list[r].text;
            }, 70);
        }

        function stopRoulette() {
            clearInterval(rouletteInterval);
            const list = tasksData[currentMode][currentZone];
            const r = Math.floor(Math.random() * list.length);
            currentTaskObj = list[r];
            const textBox = document.getElementById('task-text');
            textBox.innerText = currentTaskObj.text;
            if(currentTaskObj.text.length > 8) textBox.classList.add('long-text');
            else textBox.classList.remove('long-text');
            
            const timeDisplay = document.getElementById('task-time-display');
            timeDisplay.innerText = `（${currentTaskObj.time}分）`;
            timeDisplay.style.opacity = 1;
            
            playSoftSound();
            document.getElementById('btn-stop-roulette').classList.add('hidden');
            document.getElementById('btn-start-task').classList.remove('hidden');
            document.getElementById('btn-cancel-task').classList.remove('hidden');
        }

        function startFocus() {
            document.getElementById('phase-roulette').classList.add('hidden');
            document.getElementById('phase-timer').classList.remove('hidden');
            document.getElementById('timer-message').innerText = `「${currentTaskObj.text}」の時間`;
            document.getElementById('btn-cancel-task').classList.add('hidden');
            
            playBGM();
            
            const now = Date.now();
            endTime = now + (currentTaskObj.time * 60 * 1000);
            totalSeconds = currentTaskObj.time * 60;
            if(totalSeconds <= 0) { completeTask(); return; }
            
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                const timeLeft = endTime - Date.now();
                totalSeconds = Math.ceil(timeLeft / 1000);
                if(totalSeconds <= 0) { completeTask(); } 
                else { updateTimerDisplay(); }
            }, 200);
        }

        function updateTimerDisplay() {
            const t = Math.max(0, totalSeconds);
            const m = Math.floor(t / 60);
            const s = t % 60;
            const mStr = m.toString().padStart(2, '0');
            const sStr = s.toString().padStart(2, '0');
            document.getElementById('timer-display').innerText = `${mStr}:${sStr}`;
        }

        function stopFocus() {
            clearInterval(timerInterval);
            stopBGM();
            resetPhase();
        }

        function completeTask() {
            clearInterval(timerInterval);
            stopBGM();
            const rand = Math.floor(Math.random() * fragments.length);
            const fragment = fragments[rand];
            collectedData.push({ date: new Date(), action: currentTaskObj.text, content: fragment });
            saveData();
            updateCount();
            alert("物語の欠片を見つけました。");
            resetPhase();
        }

        function resetPhase() {
            document.getElementById('phase-timer').classList.add('hidden');
            document.getElementById('phase-roulette').classList.remove('hidden');
            document.getElementById('btn-start-task').classList.add('hidden');
            document.getElementById('btn-cancel-task').classList.add('hidden');
            document.getElementById('btn-spin').classList.remove('hidden');
            const textBox = document.getElementById('task-text');
            textBox.innerText = "ページをめくる";
            textBox.classList.remove('long-text');
            document.getElementById('task-time-display').style.opacity = 0;
        }

        function showDayMode() {
            document.getElementById('day-mode').classList.remove('hidden');
            document.getElementById('night-mode').classList.add('hidden');
        }

        function showNightMode() {
            document.getElementById('day-mode').classList.add('hidden');
            document.getElementById('night-mode').classList.remove('hidden');
        }

        function forceNightMode() { showNightMode(); }

        function updateCount() {
            document.getElementById('count-display').innerText = toKanji(collectedData.length);
        }

        function saveData() { localStorage.setItem('anthology_data_v52', JSON.stringify(collectedData)); }

        function loadData() {
            const data = localStorage.getItem('anthology_data_v52');
            if(data) {
                collectedData = JSON.parse(data);
                collectedData.forEach(d => d.date = new Date(d.date));
            }
        }

        function playSoftSound() {
            if(!isSoundOn) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        }

        function printBook() {
            if(collectedData.length === 0) { alert("白紙です。"); return; }
            const printArea = document.getElementById('print-area');
            const firstDate = collectedData[0].date;
            const dateStr = `${toKanji(firstDate.getFullYear())}年 ${toKanji(firstDate.getMonth()+1)}月 ${toKanji(firstDate.getDate())}日`;
            let html = `<div class="book-title-page"><div class="book-title">夜明けのアンソロジー</div><div class="book-date">${dateStr}</div></div>`;
            collectedData.forEach(item => {
                const h = new Date(item.date).getHours();
                const m = new Date(item.date).getMinutes();
                html += `<div class="chapter"><div class="chapter-header">試み：${item.action}</div><div class="chapter-text">${item.content.text}</div><div class="chapter-footer">― ${item.content.theme}</div></div>`;
            });
            printArea.innerHTML = html;
            window.print();
        }
    </script>
</body>
</html>